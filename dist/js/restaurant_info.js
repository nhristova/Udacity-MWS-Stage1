import{WorkerRegister}from'./workerRegister.js';import{shared}from'./shared.js';export function RestaurantService(){const a=this;this.restaurant,this.map,this.modal,window.onload=()=>{a.fetchRestaurantFromURL(n=>{n?console.error(n):(f(),b(),a.modal=document.getElementById('review-modal'),document.getElementById('open-modal').addEventListener('click',j),shared.initStarFav(document.getElementById('star-fav-'+a.restaurant.id)),GoogleMapsLoader.KEY='AIzaSyD7KC8kdJmtPQc1QOG9QFJP-I9Nd-i5eC0',GoogleMapsLoader.LIBRARIES=['places'],GoogleMapsLoader.load(this.initMap),new WorkerRegister)})},this.initMap=()=>{a.map=new google.maps.Map(document.getElementById('map'),{zoom:16,center:a.restaurant.latlng,scrollwheel:!1}),DBHelper.mapMarkerForRestaurant(a.restaurant,a.map)},this.fetchRestaurantFromURL=n=>{if(a.restaurant)return void n(null,a.restaurant);const o=g('id');if(!o){n('No restaurant id in URL',null)}else DBHelper.fetchRestaurantById(o,(p,q)=>{return q?void(a.restaurant=q,n(null,q)):void console.error(p)})};const b=(n=this.restaurant)=>{const o=document.getElementById('restaurant-name');o.innerHTML=n.name;const p=document.getElementById('restaurant-address');p.innerHTML=n.address,p.setAttribute('aria-label','Address: '+n.address+'.');const q=document.getElementById('star-fav');q.id+='-'+n.id,(!0===n.is_favorite||'true'===n.is_favorite)&&(q.setAttribute('checked',!0),q.classList.add('star-checked'));const r=DBHelper.imageUrlForRestaurant(n),s=document.getElementById('restaurant-img');s.className='restaurant-img',s.alt=n.description,s.src=r,s.srcset=`${r.replace('.jpg','_small.jpg')} 400w, ${r} 800w`,s.sizes='(min-width: 481px) 50vw, 100vw';const t=document.getElementById('restaurant-cuisine');t.innerHTML=n.cuisine_type,t.setAttribute('aria-label','Cuisine: '+n.cuisine_type+'.'),n.operating_hours&&c(),d()},c=(n=this.restaurant.operating_hours)=>{const o=document.getElementById('restaurant-hours');for(let p in o.setAttribute('aria-label','Restaurant hours'),n){const q=document.createElement('tr'),r=document.createElement('td');r.innerHTML=p,q.appendChild(r);const s=document.createElement('td');s.innerHTML=n[p],q.appendChild(s),o.appendChild(q)}},d=(n=this.restaurant.reviews)=>{const o=document.getElementById('reviews-container'),p=document.createElement('h3');if(p.innerHTML='Reviews',o.appendChild(p),!n||0===n.length){const r=document.createElement('p');return r.innerHTML='No reviews yet!',void o.appendChild(r)}const q=document.getElementById('reviews-list');n.forEach(r=>{q.appendChild(e(r))}),o.appendChild(q)},e=n=>{const o=document.createElement('li'),p=document.createElement('p');p.innerHTML=n.name,o.appendChild(p);const q=document.createElement('p'),r=new Date(n.createdAt);q.innerHTML=r.toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'}),o.appendChild(q);const t=document.createElement('p');t.innerHTML=`Rating: ${n.rating}`,o.appendChild(t);const u=document.createElement('p');return u.innerHTML=n.comments,o.appendChild(u),o},f=(n=this.restaurant)=>{const o=document.getElementById('breadcrumb'),p=document.createElement('li');p.setAttribute('aria-current','page'),p.innerHTML=n.name,o.appendChild(p)},g=(n,o)=>{o||(o=window.location.href),n=n.replace(/[\[\]]/g,'\\$&');const p=new RegExp(`[?&]${n}(=([^&#]*)|&|#|$)`),q=p.exec(o);return q?q[2]?decodeURIComponent(q[2].replace(/\+/g,' ')):'':null},h=function(){return fetch('review-modal.html').then(n=>n.text()).catch(n=>console.log('restaurant_info fetchModalHTML Error fetching review-modal from network',n))},i=function(n){const o=document.getElementById('reviews-list');o.insertAdjacentElement('afterbegin',e(n))},j=function(n=a.restaurant,o=a.modal){return o.hasChildNodes()?void l(o):void h().then(p=>{o.innerHTML=p,document.getElementById('restaurant_id').value=n.id,document.getElementById('modal-title').innerHTML+=n.name,l(o);const q=document.activeElement;o.addEventListener('click',r=>{(r.target===o||'cancel'===r.target.id||'close'===r.target.id)&&(l(o),document.forms['new-review-form'].reset(),q.focus())}),k(q),document.forms['new-review-form'].onsubmit=function(r){r.preventDefault(),m(r.target)}}).catch(p=>console.log('restaurant_info initNewReviewModal Error',p))},k=function(n,o=a.modal){var q=o.querySelectorAll('a[href], area[href], input:not([disabled]), select:not([disabled]), textarea:not([disabled]), button:not([disabled]), iframe, object, embed, [tabindex="0"], [contenteditable]');q=Array.prototype.slice.call(q);var r=q[0],s=q[q.length-1];o.addEventListener('keydown',t=>{t.shiftKey&&9===t.keyCode&&document.activeElement===r&&(t.preventDefault(),s.focus()),9!==t.keyCode||t.shiftKey||document.activeElement!==s||(t.preventDefault(),r.focus()),27===t.keyCode&&(l(o),n.focus())})},l=function(n){n.classList.contains('isHidden')?n.classList.remove('isHidden'):n.classList.add('isHidden')},m=function(n){let o={};o[n.restaurant_id.name]=parseInt(n.restaurant_id.value),o[n.name.name]=n.name.value,o[n.rating.name]=parseInt(n.rating.value),o[n.review.name]=n.review.value,o.createdAt=new Date,DBHelper.saveNewReview(o).then(p=>{i(p),l(a.modal),document.forms['new-review-form'].reset()})}}
