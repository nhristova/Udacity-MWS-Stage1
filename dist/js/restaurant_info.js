import{WorkerRegister}from'./workerRegister.js';import{shared}from'./shared.js';export function RestaurantService(){const a=this;this.restaurant,this.map,window.onload=()=>{a.fetchRestaurantFromURL(m=>{m?console.error(m):(f(),b(),j(),shared.initStarFav(document.getElementById('star-fav-'+a.restaurant.id)),GoogleMapsLoader.KEY='AIzaSyD7KC8kdJmtPQc1QOG9QFJP-I9Nd-i5eC0',GoogleMapsLoader.LIBRARIES=['places'],GoogleMapsLoader.load(this.initMap),new WorkerRegister)})},this.initMap=()=>{a.map=new google.maps.Map(document.getElementById('map'),{zoom:16,center:a.restaurant.latlng,scrollwheel:!1}),DBHelper.mapMarkerForRestaurant(a.restaurant,a.map)},this.fetchRestaurantFromURL=m=>{if(a.restaurant)return void m(null,a.restaurant);const n=g('id');if(!n){m('No restaurant id in URL',null)}else DBHelper.fetchRestaurantById(n,(o,p)=>{return p?void(a.restaurant=p,m(null,p)):void console.error(o)})};const b=(m=this.restaurant)=>{const n=document.getElementById('restaurant-name');n.innerHTML=m.name;const o=document.getElementById('restaurant-address');o.innerHTML=m.address,o.setAttribute('aria-label','Address: '+m.address+'.');const p=document.getElementById('star-fav');p.id+='-'+m.id,m.is_favorite&&(p.setAttribute('checked',!0),p.classList.add('star-checked'));const q=DBHelper.imageUrlForRestaurant(m),r=document.getElementById('restaurant-img');r.className='restaurant-img',r.alt=m.description,r.src=q,r.srcset=`${q.replace('.jpg','_small.jpg')} 400w, ${q} 800w`,r.sizes='(min-width: 481px) 50vw, 100vw';const s=document.getElementById('restaurant-cuisine');s.innerHTML=m.cuisine_type,s.setAttribute('aria-label','Cuisine: '+m.cuisine_type+'.'),m.operating_hours&&c(),d()},c=(m=this.restaurant.operating_hours)=>{const n=document.getElementById('restaurant-hours');for(let o in n.setAttribute('aria-label','Restaurant hours'),m){const p=document.createElement('tr'),q=document.createElement('td');q.innerHTML=o,p.appendChild(q);const r=document.createElement('td');r.innerHTML=m[o],p.appendChild(r),n.appendChild(p)}},d=(m=this.restaurant.reviews)=>{const n=document.getElementById('reviews-container'),o=document.createElement('h3');if(o.innerHTML='Reviews',n.appendChild(o),!m||0===m.length){const q=document.createElement('p');return q.innerHTML='No reviews yet!',void n.appendChild(q)}const p=document.getElementById('reviews-list');m.forEach(q=>{p.appendChild(e(q))}),n.appendChild(p)},e=m=>{const n=document.createElement('li'),o=document.createElement('p');o.innerHTML=m.name,n.appendChild(o);const p=document.createElement('p'),q=new Date(m.createdAt);p.innerHTML=q.toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'}),n.appendChild(p);const s=document.createElement('p');s.innerHTML=`Rating: ${m.rating}`,n.appendChild(s);const t=document.createElement('p');return t.innerHTML=m.comments,n.appendChild(t),n},f=(m=this.restaurant)=>{const n=document.getElementById('breadcrumb'),o=document.createElement('li');o.setAttribute('aria-current','page'),o.innerHTML=m.name,n.appendChild(o)},g=(m,n)=>{n||(n=window.location.href),m=m.replace(/[\[\]]/g,'\\$&');const o=new RegExp(`[?&]${m}(=([^&#]*)|&|#|$)`),p=o.exec(n);return p?p[2]?decodeURIComponent(p[2].replace(/\+/g,' ')):'':null},h=function(m=a.restaurant){const n=document.createElement('div');n.id='modal-content',n.classList.add('modal-content');const o=document.createElement('header');o.classList.add('modal-header');const p=document.createElement('span');p.innerHTML='&times;',p.id='close',p.classList.add('close'),o.appendChild(p);const q=document.createElement('h2');q.innerHTML=`New review for ${m.name}`,o.appendChild(q),n.appendChild(o);const r=document.createElement('div');r.classList.add('modal-body');const s=document.createElement('form');s.id='new-review-form',s.action='http://localhost:1337/reviews/',s.method='POST',s.innerHTML=`<div>
                <input type="hidden" id="restaurant_id" name="restaurant_id" value=${m.id}>
                <label for="name">Name:
                </label>
                <input id="name" name="name" type="text">
            </div>
            <div>
                <label for="rating">Rating: </label>
                <select id="rating" name="rating">
                    <option>1</option>
                    <option>2</option>
                    <option>3</option>
                    <option>4</option>
                    <option>5</option>
                </select>
            </div>
            <div id="star-rating">
                <span id="star1" class="star star-checked">★</span>
                <span id="star2" class="star star-checked">★</span>
                <span id="star3" class="star star-checked">★</span>
                <span id="star4" class="star star-empty">★</span>
                <span id="star5" class="star star-empty">★</span>
            </div>
            <div>
                <label for="review">Your comments:</label>
                <textarea id="review" name="comments" cols="30" rows="10"></textarea>
            </div>`,r.appendChild(s),n.appendChild(r);const t=document.createElement('footer');return t.classList.add('modal-footer'),t.innerHTML=`<button id="submit-btn" class="btn btn-warning" form="new-review-form" type="submit">Save</button>
        <button id="cancel" class="btn btn-default">Cancel</button>`,n.appendChild(t),n},i=function(m){const n=document.getElementById('reviews-list');n.insertAdjacentElement('afterbegin',e(m))},j=function(){const m=document.getElementById('review-modal'),n=h();m.appendChild(n),window.addEventListener('click',function(o){o.target===m||'cancel'===o.target.id||'close'===o.target.id?(k(m),document.forms['new-review-form'].reset()):'open-modal'===o.target.id&&k(m)}),document.forms['new-review-form'].onsubmit=function(o){o.preventDefault(),l(o.target)}},k=function(m){m.classList.contains('isHidden')?m.classList.remove('isHidden'):m.classList.add('isHidden')},l=function(m){let n={};n[m.restaurant_id.name]=parseInt(m.restaurant_id.value),n[m.name.name]=m.name.value,n[m.rating.name]=parseInt(m.rating.value),n[m.review.name]=m.review.value,n.createdAt=new Date,DBHelper.saveNewReview(n).then(o=>{i(o),k(document.getElementById('review-modal')),document.forms['new-review-form'].reset()})}}
