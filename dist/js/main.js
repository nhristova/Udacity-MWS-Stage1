import{WorkerRegister}from'./workerRegister.js';import{shared}from'./shared.js';let restaurants,neighborhoods,cuisines,map,markers=[];const mapParams={center:{lat:40.722216,lng:-73.987501},zoom:11,key:'AIzaSyD7KC8kdJmtPQc1QOG9QFJP-I9Nd-i5eC0'};window.onload=()=>{fetchNeighborhoods(),fetchCuisines(),updateRestaurants(),shared.initStarFav(document.getElementById('restaurants-list')),document.getElementById('map').addEventListener('click',()=>{GoogleMapsLoader.KEY=mapParams.key,GoogleMapsLoader.LIBRARIES=['places'],GoogleMapsLoader.load(initMap)}),new WorkerRegister};const fetchNeighborhoods=()=>{DBHelper.fetchNeighborhoods((a,b)=>{a?console.error(a):(self.neighborhoods=b,fillNeighborhoodsHTML())})},fillNeighborhoodsHTML=(a=self.neighborhoods)=>{const b=document.getElementById('neighborhoods-select');b.addEventListener('change',updateRestaurants),a.forEach(c=>{const d=document.createElement('option');d.innerHTML=c,d.value=c,b.append(d)})},fetchCuisines=()=>{DBHelper.fetchCuisines((a,b)=>{a?console.error(a):(self.cuisines=b,fillCuisinesHTML())})},fillCuisinesHTML=(a=self.cuisines)=>{const b=document.getElementById('cuisines-select');b.addEventListener('change',updateRestaurants),a.forEach(c=>{const d=document.createElement('option');d.innerHTML=c,d.value=c,b.append(d)})},initMap=()=>{self.map=new google.maps.Map(document.getElementById('map'),{zoom:mapParams.zoom,center:mapParams.center,scrollwheel:!1}),addMarkersToMap()},initStaticMap=(a=self.restaurants)=>{const b=document.getElementById('map'),c=window.outerWidth,d=window.outerWidth,e=window.devicePixelRatio,f=a.map(i=>`&markers=${i.latlng.lat},${i.latlng.lng}`).join(''),g=`https://maps.googleapis.com/maps/api/staticmap?center=${mapParams.center.lat},${mapParams.center.lng}&zoom=${mapParams.zoom}&size=${c}x${d}&scale=${e}&maptype=roadmap${f}&key=${mapParams.key}`,h=document.createElement('img');h.src=g,h.alt='Static Google map of restaurant locations. Click to load',b.innerHTML='',b.appendChild(h)},updateRestaurants=()=>{const a=document.getElementById('cuisines-select'),b=document.getElementById('neighborhoods-select'),c=a.selectedIndex,d=b.selectedIndex,e=a[c].value,f=b[d].value;DBHelper.fetchRestaurantByCuisineAndNeighborhood(e,f,(g,h)=>{g?console.log(g):(resetRestaurants(h),initStaticMap(h),fillRestaurantsHTML())})},resetRestaurants=a=>{self.restaurants=[];const b=document.getElementById('restaurants-list');b.innerHTML='',self.restaurants=a,markers&&(markers.forEach(c=>c.setMap(null)),markers=[])},fillRestaurantsHTML=(a=self.restaurants)=>{const b=document.getElementById('restaurants-list');a.forEach(c=>{b.append(createRestaurantHTML(c))})},createRestaurantHTML=a=>{const b=document.createElement('li'),c=DBHelper.imageUrlForRestaurant(a),d=document.createElement('span');d.id='star-fav-'+a.id,d.classList.add('star','star-fav'),d.setAttribute('role','checkbox'),d.setAttribute('title','Mark restaurant as favourite'),d.setAttribute('tabindex',0),d.innerHTML='\u2605';const e=!0===a.is_favorite||'true'===a.is_favorite;e&&(d.setAttribute('checked',e),d.classList.add('star-checked')),b.append(d);const f=document.createElement('img');f.className='restaurant-img',f.alt=a.description,f.src=c,f.srcset=`${c.replace('.jpg','_small.jpg')} 400w, ${c} 800w`,f.sizes='(min-width: 480px) 40vw, (min-width: 721px) 29vw, (min-width: 1000px) 22vw',b.append(f);const g=document.createElement('h2');g.innerHTML=a.name,b.append(g);const h=document.createElement('p');h.classList.add('neighborhood'),h.innerHTML=a.neighborhood,b.append(h);const i=document.createElement('p');i.innerHTML=a.address,b.append(i);const j=document.createElement('a');return j.innerHTML='View Details',j.href=DBHelper.urlForRestaurant(a),j.classList.add('btn','btn-warning'),j.setAttribute('aria-label','. Details for restaurant: '+a.name),b.append(j),b},addMarkersToMap=(a=self.restaurants)=>{a.forEach(b=>{const c=DBHelper.mapMarkerForRestaurant(b,self.map);google.maps.event.addListener(c,'click',()=>{window.location.href=c.url}),markers.push(c)})};
